<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.121.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Flink Window Trigger 使用的正确姿势"><meta itemprop=description content="flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/img/avatar.jpg"><meta itemprop=keywords content="大数据"><meta property="og:type" content="article"><meta property="og:title" content="Flink Window Trigger 使用的正确姿势"><meta property="og:description" content="flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi"><meta property="og:image" content="/img/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi/"><meta property="og:site_name" content="Patrick's Blog"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Patrick"><meta property="article:published_time" content="2022-12-25 09:39:52 +0800 CST"><meta property="article:modified_time" content="2024-04-04 12:26:19 +0800 CST"><link type=text/css rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://unpkg.com/animate.css@3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://unpkg.com/viewerjs@1.11.0/dist/viewer.min.css><link rel=stylesheet href=/css/main.min.a987c3fbca3727259a25c99140afed885cbffe7b77dba717d89bbe0780afcd01.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"math":{"css":{"file":"dist/katex.min.css","name":"katex","version":"0.16.0"},"js":[{"file":"dist/katex.min.js","name":"katex","version":"0.16.0"},{"alias_name":"katex","file":"dist/contrib/auto-render.min.js","name":"auto-render","version":"0.16.0"}],"render":"katex"},"path":"flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi","permalink":"/post/flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi/","title":"Flink Window Trigger 使用的正确姿势","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Flink Window Trigger 使用的正确姿势 - Patrick's Blog</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Patrick's Blog</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Once start, goes forward!</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-flinks"><a href=/flinks.html class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>站点示例</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>33</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#废话>废话</a></li><li><a href=#从一个数据处理延迟告警说起>从一个数据处理延迟告警说起</a><ul><li><a href=#解决过程>解决过程</a></li><li><a href=#发现问题>发现问题</a></li><li><a href=#验证预聚合逻辑>验证预聚合逻辑</a><ul><li><a href=#预聚合逻辑>预聚合逻辑</a></li><li><a href=#运行测试>运行测试</a></li><li><a href=#运行结果>运行结果</a></li><li><a href=#排查>排查</a></li></ul></li><li><a href=#自定义-trigger-实现>自定义 Trigger 实现</a><ul><li><a href=#解决思路>解决思路</a></li><li><a href=#测试及运行结果>测试及运行结果</a></li></ul></li></ul></li><li><a href=#总结>总结</a><ul><li><a href=#关于-continuouseventtimetrigger-的使用>关于 ContinuousEventTimeTrigger 的使用</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Patrick src=/imgs/img-lazy-loading.gif data-src=/img/avatar.jpg><p class=site-author-name itemprop=name>Patrick</p><div class=site-description itemprop=description>个人学习笔记</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>33</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>4</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>8</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2015-04-05T13:57:58+08:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=22332></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=121></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-05-31T21:26:21+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/img/avatar.jpg"><meta itemprop=name content="Patrick"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Patrick"><meta itemprop=description content="个人学习笔记"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Flink Window Trigger 使用的正确姿势"><meta itemprop=description content="flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi"></span><header class=post-header><h1 class=post-title itemprop="name headline">Flink Window Trigger 使用的正确姿势
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/post/flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2022-12-25 09:39:52 +0800 CST" itemprop="dateCreated datePublished" datetime="2022-12-25 09:39:52 +0800 CST">2022-12-25
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-04-04T12:26:19+08:00 itemprop=dateModified datetime=2024-04-04T12:26:19+08:00>2024-04-04</time>
</span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6 itemprop=url rel=index><span itemprop=name>数据科学</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>1122</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>6分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=废话>废话
<a class=header-anchor href=#%e5%ba%9f%e8%af%9d></a></h2><ul><li>在使用 Flink DataStream API 进行流式数据聚合统计时, sink操作时, 都会用到 Trigger.</li><li>以 Flink 1.11.x 版本为例, 查看 Trigger 的实现类主要有以下常用的 7 种:<ul><li><code>EventTimeTrigger</code>: 事件时间触发器</li><li><code>ProcessTimeTrigger</code>: 处理时间触发器</li><li><code>ContinuousEventTimeTrigger</code>: 连续的事件时间触发器</li><li><code>ContinuousProcessingTimeTrigger</code>: 连续的处理时间触发器</li><li><code>CountTrigger</code>: 窗口数据条数触发器</li><li><code>DeltaTrigger</code>: 窗口Delta指标触发器</li><li><code>PurgingTrigger</code>: 窗口清除触发器</li></ul></li><li>在实际的业务场景中, 使用最多的当属 ContinuousEventTimeTrigger 这个类了.</li></ul><h2 id=从一个数据处理延迟告警说起>从一个数据处理延迟告警说起
<a class=header-anchor href=#%e4%bb%8e%e4%b8%80%e4%b8%aa%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86%e5%bb%b6%e8%bf%9f%e5%91%8a%e8%ad%a6%e8%af%b4%e8%b5%b7></a></h2><ul><li>线上稳定运行了将近两周的 Job, 突然收到告警, 出现了半小时以上的数据处理延迟. 立即查看 Job 的 UI 及监控指标页面, 发现 checkpoint 出现了超时, 定位原因是两周前重新划分了渠道维表大类, 某个渠道类别 keyby 聚合算子因存在数据热点问题, TaskManager 出现了性能处理瓶颈, 导致 Kafka Source 端出现了严重的反压, 数据处理出现了延迟.</li></ul><h3 id=解决过程>解决过程
<a class=header-anchor href=#%e8%a7%a3%e5%86%b3%e8%bf%87%e7%a8%8b></a></h3><ul><li>处理原则就是尽量的打散数据聚合的 key, 均匀的落在每个 Task 上.</li><li>套用以往 SparkStreaming 优化的经验来看还是十分的简单, 于是使用 map 算子增加随机的 key, 再 reduce 做预聚合, 最后再按窗口来进行汇总. 不出半小时改完上预发布环境测试, 查看了下数据流一切正常后上线生产, 重跑当日数据. 观察了当天上午每小时的大屏数据折线趋势图, 相比昨天大概有 5% 左右的涨幅, 在有活动的情况下看起来还算正常.</li></ul><h3 id=发现问题>发现问题
<a class=header-anchor href=#%e5%8f%91%e7%8e%b0%e9%97%ae%e9%a2%98></a></h3><ul><li>下午再次查看大屏数据, 当日的累计成交订单数已经超过前两天之和; 按小时核对明细层数据, 没发现问题, 再看报表聚合层逻辑, 定位问题出现在预聚合计算逻辑.</li></ul><h3 id=验证预聚合逻辑>验证预聚合逻辑
<a class=header-anchor href=#%e9%aa%8c%e8%af%81%e9%a2%84%e8%81%9a%e5%90%88%e9%80%bb%e8%be%91></a></h3><ul><li>为了验证这个问题, 启动本地 Docker kafka 并灌入乱序数据, 来验证预聚合逻辑.</li></ul><h4 id=预聚合逻辑>预聚合逻辑
<a class=header-anchor href=#%e9%a2%84%e8%81%9a%e5%90%88%e9%80%bb%e8%be%91></a></h4><ul><li>需求: 按天统计渠道大类的下单数/GMV/用户数, 每秒进行更新</li><li>此处简化了生产聚合逻辑, 模拟按天开窗设置成按分钟开窗, 便于观察数据聚合情况, 即按分钟统计大类的下单数, 每秒更新.</li><li>以下为 scala 代码</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>TriggerTest</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>App</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> <span style=color:#f92672>(</span>env<span style=color:#f92672>,</span> tableEnv<span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>FlinkUtil</span><span style=color:#f92672>.</span>initStreamEnv<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> props <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Properties</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  props<span style=color:#f92672>.</span>put<span style=color:#f92672>(</span><span style=color:#a6e22e>ConsumerConfig</span><span style=color:#f92672>.</span><span style=color:#a6e22e>BOOTSTRAP_SERVERS_CONFIG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;127.0.0.1:9092&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  props<span style=color:#f92672>.</span>put<span style=color:#f92672>(</span><span style=color:#a6e22e>ConsumerConfig</span><span style=color:#f92672>.</span><span style=color:#a6e22e>GROUP_ID_CONFIG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;com_patrick_stream_test&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> kafkaConsumer<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>FlinkKafkaConsumer010</span><span style=color:#f92672>[</span><span style=color:#66d9ef>String</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>FlinkKafkaConsumer010</span><span style=color:#f92672>[</span><span style=color:#66d9ef>String</span><span style=color:#f92672>](</span><span style=color:#e6db74>&#34;goods_cat&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SimpleStringSchema</span><span style=color:#f92672>(),</span> props<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  kafkaConsumer<span style=color:#f92672>.</span>setCommitOffsetsOnCheckpoints<span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  kafkaConsumer<span style=color:#f92672>.</span>setStartFromLatest<span style=color:#f92672>()</span> <span style=color:#75715e>// 此处为了便于测试, 每次从最新的 offset 消费, 线上环境可以从指定时间消费
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> goodsCatDS<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>DataStream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>GoodsCat</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> env
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>addSource<span style=color:#f92672>(</span>kafkaConsumer<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>map<span style=color:#f92672>(</span>item <span style=color:#66d9ef>=&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>val</span> strArr<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Array</span><span style=color:#f92672>[</span><span style=color:#66d9ef>String</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> item<span style=color:#f92672>.</span>split<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>GoodsCat</span><span style=color:#f92672>(</span>strArr<span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>).</span>trim<span style=color:#f92672>,</span> strArr<span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>).</span>trim<span style=color:#f92672>.</span>toInt<span style=color:#f92672>,</span> <span style=color:#a6e22e>DateUtil</span><span style=color:#f92672>.</span>formatDateToTimestamp<span style=color:#f92672>(</span>strArr<span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>).</span>trim<span style=color:#f92672>)</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>assignTimestampsAndWatermarks<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>WatermarkStrategy</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>forBoundedOutOfOrderness<span style=color:#f92672>[</span><span style=color:#66d9ef>GoodsCat</span><span style=color:#f92672>](</span><span style=color:#a6e22e>Duration</span><span style=color:#f92672>.</span>ofSeconds<span style=color:#f92672>(</span><span style=color:#ae81ff>20</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>withTimestampAssigner<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SerializableTimestampAssigner</span><span style=color:#f92672>[</span><span style=color:#66d9ef>GoodsCat</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> extractTimestamp<span style=color:#f92672>(</span>element<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GoodsCat</span><span style=color:#f92672>,</span> recordTimestamp<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            element<span style=color:#f92672>.</span>ts
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  goodsCatDS<span style=color:#f92672>.</span>print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;source-goods-cat&#34;</span><span style=color:#f92672>).</span>setParallelism<span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> firstGoodsCatAggDS<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>DataStream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>GoodsCatTmp</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> goodsCatDS
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>map<span style=color:#f92672>(</span>item <span style=color:#66d9ef>=&gt;</span> <span style=color:#a6e22e>GoodsCatTmp</span><span style=color:#f92672>(</span><span style=color:#a6e22e>DateUtil</span><span style=color:#f92672>.</span>formatKeyDayHourMinute<span style=color:#f92672>(</span>item<span style=color:#f92672>.</span>ts<span style=color:#f92672>),</span> item<span style=color:#f92672>.</span>catId<span style=color:#f92672>,</span> item<span style=color:#f92672>.</span>cnt<span style=color:#f92672>,</span> item<span style=color:#f92672>.</span>ts<span style=color:#f92672>,</span> <span style=color:#a6e22e>Random</span><span style=color:#f92672>.</span>nextInt<span style=color:#f92672>(</span><span style=color:#ae81ff>3</span><span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>keyBy<span style=color:#f92672>(</span>item <span style=color:#66d9ef>=&gt;</span> <span style=color:#f92672>(</span>item<span style=color:#f92672>.</span>catId<span style=color:#f92672>,</span> item<span style=color:#f92672>.</span>pKey<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>timeWindow<span style=color:#f92672>(</span><span style=color:#a6e22e>Time</span><span style=color:#f92672>.</span>minutes<span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>trigger<span style=color:#f92672>(</span><span style=color:#a6e22e>ContinuousEventTimeTrigger</span><span style=color:#f92672>.</span>of<span style=color:#f92672>[</span><span style=color:#66d9ef>TimeWindow</span><span style=color:#f92672>](</span><span style=color:#a6e22e>Time</span><span style=color:#f92672>.</span>seconds<span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>reduce<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ReduceFunction</span><span style=color:#f92672>[</span><span style=color:#66d9ef>GoodsCatTmp</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> reduce<span style=color:#f92672>(</span>value1<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GoodsCatTmp</span><span style=color:#f92672>,</span> value2<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GoodsCatTmp</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GoodsCatTmp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>GoodsCatTmp</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        value1<span style=color:#f92672>.</span>periodId<span style=color:#f92672>,</span> value1<span style=color:#f92672>.</span>catId<span style=color:#f92672>,</span> value1<span style=color:#f92672>.</span>cnt <span style=color:#f92672>+</span> value2<span style=color:#f92672>.</span>cnt<span style=color:#f92672>,</span> <span style=color:#a6e22e>Math</span><span style=color:#f92672>.</span>max<span style=color:#f92672>(</span>value1<span style=color:#f92672>.</span>ts<span style=color:#f92672>,</span> value2<span style=color:#f92672>.</span>ts<span style=color:#f92672>),</span> value1<span style=color:#f92672>.</span>pKey
</span></span><span style=display:flex><span>      <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  firstGoodsCatAggDS<span style=color:#f92672>.</span>print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;cat-first-agg&#34;</span><span style=color:#f92672>).</span>setParallelism<span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> secondGoodsCatAggDS<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>DataStream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>GoodsCatTmp</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> firstGoodsCatAggDS
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>keyBy<span style=color:#f92672>(</span>item <span style=color:#66d9ef>=&gt;</span> <span style=color:#f92672>(</span>item<span style=color:#f92672>.</span>periodId<span style=color:#f92672>,</span> item<span style=color:#f92672>.</span>catId<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>reduce<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ReduceFunction</span><span style=color:#f92672>[</span><span style=color:#66d9ef>GoodsCatTmp</span><span style=color:#f92672>]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> reduce<span style=color:#f92672>(</span>value1<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GoodsCatTmp</span><span style=color:#f92672>,</span> value2<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GoodsCatTmp</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GoodsCatTmp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>GoodsCatTmp</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        value1<span style=color:#f92672>.</span>periodId<span style=color:#f92672>,</span> value1<span style=color:#f92672>.</span>catId<span style=color:#f92672>,</span> value1<span style=color:#f92672>.</span>cnt <span style=color:#f92672>+</span> value2<span style=color:#f92672>.</span>cnt<span style=color:#f92672>,</span> <span style=color:#a6e22e>Math</span><span style=color:#f92672>.</span>max<span style=color:#f92672>(</span>value1<span style=color:#f92672>.</span>ts<span style=color:#f92672>,</span> value2<span style=color:#f92672>.</span>ts<span style=color:#f92672>),</span> value1<span style=color:#f92672>.</span>pKey
</span></span><span style=display:flex><span>      <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  secondGoodsCatAggDS<span style=color:#f92672>.</span>print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;cat-second-agg&#34;</span><span style=color:#f92672>).</span>setParallelism<span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  env<span style=color:#f92672>.</span>execute<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;trigger-test&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GoodsCat</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                     catId<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                     cnt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                     ts<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span>
</span></span><span style=display:flex><span>                   <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GoodsCatTmp</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                        periodId<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span> <span style=color:#75715e>// yyyyMMddHHmm 格式的分钟 key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        catId<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        cnt<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        ts<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        pKey<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span>
</span></span><span style=display:flex><span>                      <span style=color:#f92672>)</span>
</span></span></code></pre></div><h4 id=运行测试>运行测试
<a class=header-anchor href=#%e8%bf%90%e8%a1%8c%e6%b5%8b%e8%af%95></a></h4><ul><li>本地 kafka 灌入乱序测试数据:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span># 商品类别, 订单数, 时间
</span></span><span style=display:flex><span>2,1,2021-10-24 20:00:10
</span></span><span style=display:flex><span>3,1,2021-10-24 20:00:29
</span></span><span style=display:flex><span>1,1,2021-10-24 20:00:18
</span></span><span style=display:flex><span>2,1,2021-10-24 20:00:46
</span></span><span style=display:flex><span>1,1,2021-10-24 20:01:08
</span></span><span style=display:flex><span>2,1,2021-10-24 20:00:55
</span></span><span style=display:flex><span>3,1,2021-10-24 20:01:27
</span></span><span style=display:flex><span>1,1,2021-10-24 20:01:39
</span></span><span style=display:flex><span>2,1,2021-10-24 20:01:51
</span></span><span style=display:flex><span>3,1,2021-10-24 20:02:03
</span></span><span style=display:flex><span>1,1,2021-10-24 20:01:57
</span></span><span style=display:flex><span>2,1,2021-10-24 20:02:26
</span></span><span style=display:flex><span>3,1,2021-10-24 20:02:41
</span></span><span style=display:flex><span>1,1,2021-10-24 20:02:53
</span></span><span style=display:flex><span>2,1,2021-10-24 20:03:04
</span></span><span style=display:flex><span>2,1,2021-10-24 20:02:58
</span></span><span style=display:flex><span>2,1,2021-10-24 20:03:32
</span></span><span style=display:flex><span>3,1,2021-10-24 20:03:57
</span></span></code></pre></div><h4 id=运行结果>运行结果
<a class=header-anchor href=#%e8%bf%90%e8%a1%8c%e7%bb%93%e6%9e%9c></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>source-goods-cat&gt; GoodsCat(2,1,1635076810000)
</span></span><span style=display:flex><span>source-goods-cat&gt; GoodsCat(3,1,1635076829000)
</span></span><span style=display:flex><span>source-goods-cat&gt; GoodsCat(1,1,1635076818000)
</span></span><span style=display:flex><span>source-goods-cat&gt; GoodsCat(2,1,1635076846000)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,4,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,6,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,8,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,10,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,12,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,14,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,16,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,18,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,20,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,22,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,24,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,26,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,28,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,30,1635076846000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,1,2,1635076818000,0)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,1,3,1635076818000,0)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,1,4,1635076818000,0)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,1,5,1635076818000,0)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,1,6,1635076818000,0)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,1,7,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,0)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,2,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,3,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,4,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,5,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,6,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,7,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,8,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,9,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,10,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,11,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,12,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,13,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,14,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,15,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,16,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,17,1635076829000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,18,1635076829000,1)
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h4 id=排查>排查
<a class=header-anchor href=#%e6%8e%92%e6%9f%a5></a></h4><ul><li>很明显, 在 2021-10-24 20:00:00 到 2021-10-24 20:00:01 这个分钟窗口内, 预聚合 (biz-first-stat) 打印中出现了多次相同的数据, 以至于结果层 (biz-second-stat), 类别 1 的订单数为 7, 而正常为1; 类别 2 的订单数为 30, 而正常为 3; 类别 3 的订单数为 18, 而正常为 1.</li><li>因此可以肯定是 ContinuousEventTimeTrigger 出现了触发相同结果的数据, 查看源码该类的注释说明</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>A Trigger that continuously fires based on a given time interval. This fires based on Watermarks.
</span></span><span style=display:flex><span>See Also:
</span></span><span style=display:flex><span>org.apache.flink.streaming.api.watermark.Watermark
</span></span><span style=display:flex><span>Type parameters:
</span></span><span style=display:flex><span>&lt;W&gt; – The type of Windows on which this trigger can operate.
</span></span></code></pre></div><ul><li>按注释理解一下, 就是按给定时间间隔<strong>持续</strong>触发计算, 该触发是基于水位线的. 那么问题很可能就出现<strong>持续</strong>上, 继续翻看源码, 重点关注 <code>onElement</code>, <code>onEventTime</code>, <code>onMerge</code>仅在两个触发器的相应窗口合并时才会调用, 可以忽略.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#75715e>/** When merging we take the lowest of all fire timestamps as the new fire timestamp. */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ReducingStateDescriptor<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> stateDesc <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>new</span> ReducingStateDescriptor<span style=color:#f92672>&lt;&gt;</span>(<span style=color:#e6db74>&#34;fire-time&#34;</span>, <span style=color:#66d9ef>new</span> Min(), LongSerializer.<span style=color:#a6e22e>INSTANCE</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 每一个数据进入窗口都会触发</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> TriggerResult <span style=color:#a6e22e>onElement</span>(Object element, <span style=color:#66d9ef>long</span> timestamp, W window, TriggerContext ctx) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (window.<span style=color:#a6e22e>maxTimestamp</span>() <span style=color:#f92672>&lt;=</span> ctx.<span style=color:#a6e22e>getCurrentWatermark</span>()) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// if the watermark is already past the window fire immediately</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 当前的水位线已经超过窗口时间, 则触发计算, 但不清除窗口数据</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> TriggerResult.<span style=color:#a6e22e>FIRE</span>;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 注册下一次窗口触发的定时器</span>
</span></span><span style=display:flex><span>			ctx.<span style=color:#a6e22e>registerEventTimeTimer</span>(window.<span style=color:#a6e22e>maxTimestamp</span>());
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取下次触发窗口计算时间</span>
</span></span><span style=display:flex><span>		ReducingState<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> fireTimestamp <span style=color:#f92672>=</span> ctx.<span style=color:#a6e22e>getPartitionedState</span>(stateDesc);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (fireTimestamp.<span style=color:#a6e22e>get</span>() <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>long</span> start <span style=color:#f92672>=</span> timestamp <span style=color:#f92672>-</span> (timestamp <span style=color:#f92672>%</span> interval);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>long</span> nextFireTimestamp <span style=color:#f92672>=</span> start <span style=color:#f92672>+</span> interval;
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 注册下一次窗口触发的定时器</span>
</span></span><span style=display:flex><span>			ctx.<span style=color:#a6e22e>registerEventTimeTimer</span>(nextFireTimestamp);
</span></span><span style=display:flex><span>			fireTimestamp.<span style=color:#a6e22e>add</span>(nextFireTimestamp);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 不做操作</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> TriggerResult.<span style=color:#a6e22e>CONTINUE</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 在 EventTime 定时器触发的时候调用</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> TriggerResult <span style=color:#a6e22e>onEventTime</span>(<span style=color:#66d9ef>long</span> time, W window, TriggerContext ctx) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (time <span style=color:#f92672>==</span> window.<span style=color:#a6e22e>maxTimestamp</span>()){
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 定时器的时间与窗口最大时间相等, 触发计算, 但不清空窗口数据</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> TriggerResult.<span style=color:#a6e22e>FIRE</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		ReducingState<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> fireTimestampState <span style=color:#f92672>=</span> ctx.<span style=color:#a6e22e>getPartitionedState</span>(stateDesc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		Long fireTimestamp <span style=color:#f92672>=</span> fireTimestampState.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (fireTimestamp <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> fireTimestamp <span style=color:#f92672>==</span> time) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 定时器的时间与触发器状态中的时间相等时, 清除并更新下一次触发时间, 注册下一个定时器, 并触发计算, 但不清空窗口数据</span>
</span></span><span style=display:flex><span>			fireTimestampState.<span style=color:#a6e22e>clear</span>();
</span></span><span style=display:flex><span>			fireTimestampState.<span style=color:#a6e22e>add</span>(time <span style=color:#f92672>+</span> interval);
</span></span><span style=display:flex><span>			ctx.<span style=color:#a6e22e>registerEventTimeTimer</span>(time <span style=color:#f92672>+</span> interval);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> TriggerResult.<span style=color:#a6e22e>FIRE</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 不做操作</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> TriggerResult.<span style=color:#a6e22e>CONTINUE</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Min</span> <span style=color:#66d9ef>implements</span> ReduceFunction<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> serialVersionUID <span style=color:#f92672>=</span> 1L;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>reduce</span>(Long value1, Long value2) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>          log.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Min ===&gt; value1={}, value2={}&#34;</span>, value1, value2);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>min</span>(value1, value2);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h3 id=自定义-trigger-实现>自定义 Trigger 实现
<a class=header-anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89-trigger-%e5%ae%9e%e7%8e%b0></a></h3><ul><li>那么如何解决这种预聚合过程中的 Trigger 输出重复的预聚合数据, 最直接的办法就是在结果层进行去重. 有没有更好的办法呢? 思考再三, 于是有了下面的自定义 Trigger</li></ul><h4 id=解决思路>解决思路
<a class=header-anchor href=#%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af></a></h4><ul><li>因结果层会对预聚合层再次累加, 同时也不存在窗口合并的情况, 不需要实现 onMerge 方法, 因此在预聚合层触发计算后可以直接清除本次窗口数据.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IntervalEventTimeTrigger</span><span style=color:#f92672>(</span>interval<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Trigger</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Any</span>, <span style=color:#66d9ef>TimeWindow</span><span style=color:#f92672>]{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>val</span> log<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Logger</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>LoggerFactory</span><span style=color:#f92672>.</span>getLogger<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span>getClass<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>val</span> fireTimeStateDesc <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ValueStateDescriptor</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Long</span><span style=color:#f92672>](</span><span style=color:#e6db74>&#34;fireTimeState&#34;</span><span style=color:#f92672>,</span> classOf<span style=color:#f92672>[</span><span style=color:#66d9ef>Long</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> onElement<span style=color:#f92672>(</span>element<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Any</span><span style=color:#f92672>,</span> timestamp<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>,</span> window<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>TimeWindow</span><span style=color:#f92672>,</span> ctx<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Trigger.TriggerContext</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>TriggerResult</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>window<span style=color:#f92672>.</span>maxTimestamp<span style=color:#f92672>()</span> <span style=color:#f92672>&lt;=</span> ctx<span style=color:#f92672>.</span>getCurrentWatermark<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// if the watermark is already past the window fire immediately
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>TriggerResult</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FIRE</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      ctx<span style=color:#f92672>.</span>registerEventTimeTimer<span style=color:#f92672>(</span>window<span style=color:#f92672>.</span>maxTimestamp<span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> fireTimestamp<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ValueState</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Long</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> ctx<span style=color:#f92672>.</span>getPartitionedState<span style=color:#f92672>(</span>fireTimeStateDesc<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> fireTime<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span> <span style=color:#f92672>=</span> fireTimestamp<span style=color:#f92672>.</span>value<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>fireTime <span style=color:#f92672>==</span> <span style=color:#ae81ff>0L</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>val</span> start<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span> <span style=color:#f92672>=</span> timestamp <span style=color:#f92672>-</span> <span style=color:#f92672>(</span>timestamp <span style=color:#f92672>%</span> interval<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>val</span> nextFireTimestamp<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span> <span style=color:#f92672>=</span> start <span style=color:#f92672>+</span> interval
</span></span><span style=display:flex><span>      fireTimestamp<span style=color:#f92672>.</span>update<span style=color:#f92672>(</span>nextFireTimestamp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      ctx<span style=color:#f92672>.</span>registerEventTimeTimer<span style=color:#f92672>(</span>nextFireTimestamp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TriggerResult</span><span style=color:#f92672>.</span><span style=color:#a6e22e>CONTINUE</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> onProcessingTime<span style=color:#f92672>(</span>time<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                window<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>TimeWindow</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                ctx<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Trigger.TriggerContext</span>
</span></span><span style=display:flex><span>                               <span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>TriggerResult</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TriggerResult</span><span style=color:#f92672>.</span><span style=color:#a6e22e>CONTINUE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> onEventTime<span style=color:#f92672>(</span>time<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>,</span> window<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>TimeWindow</span><span style=color:#f92672>,</span> ctx<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Trigger.TriggerContext</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>TriggerResult</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>time <span style=color:#f92672>==</span> window<span style=color:#f92672>.</span>maxTimestamp<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>TriggerResult</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FIRE_AND_PURGE</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> fireTimestamp<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ValueState</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Long</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> ctx<span style=color:#f92672>.</span>getPartitionedState<span style=color:#f92672>(</span>fireTimeStateDesc<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> timestamp<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span> <span style=color:#f92672>=</span> fireTimestamp<span style=color:#f92672>.</span>value<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timestamp <span style=color:#f92672>==</span> time<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      fireTimestamp<span style=color:#f92672>.</span>clear<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      fireTimestamp<span style=color:#f92672>.</span>update<span style=color:#f92672>(</span>time <span style=color:#f92672>+</span> interval<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      ctx<span style=color:#f92672>.</span>registerEventTimeTimer<span style=color:#f92672>(</span>time <span style=color:#f92672>+</span> interval<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>TriggerResult</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FIRE_AND_PURGE</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TriggerResult</span><span style=color:#f92672>.</span><span style=color:#a6e22e>CONTINUE</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> clear<span style=color:#f92672>(</span>window<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>TimeWindow</span><span style=color:#f92672>,</span> ctx<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Trigger.TriggerContext</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Unit</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> fireTimestamp<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ValueState</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Long</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> ctx<span style=color:#f92672>.</span>getPartitionedState<span style=color:#f92672>(</span>fireTimeStateDesc<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> timestamp<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span> <span style=color:#f92672>=</span> fireTimestamp<span style=color:#f92672>.</span>value<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timestamp <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      ctx<span style=color:#f92672>.</span>deleteEventTimeTimer<span style=color:#f92672>(</span>timestamp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      fireTimestamp<span style=color:#f92672>.</span>clear<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>IntervalEventTimeTrigger</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> of<span style=color:#f92672>(</span>interval<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Time</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>IntervalEventTimeTrigger</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>IntervalEventTimeTrigger</span><span style=color:#f92672>(</span>interval<span style=color:#f92672>.</span>toMilliseconds<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=测试及运行结果>测试及运行结果
<a class=header-anchor href=#%e6%b5%8b%e8%af%95%e5%8f%8a%e8%bf%90%e8%a1%8c%e7%bb%93%e6%9e%9c></a></h4><ul><li>依然重新灌入相同的乱序数据</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,2)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,2)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,2)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242000,2,1,1635076855000,2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,2,1635076846000,2)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,1,1,1635076818000,2)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,3,1,1635076829000,2)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242000,2,3,1635076855000,2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242001,1,2,1635076899000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242001,3,1,1635076887000,1)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242001,1,1,1635076917000,2)
</span></span><span style=display:flex><span>cat-first-agg&gt; GoodsCatTmp(202110242001,2,1,1635076911000,1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242001,1,2,1635076899000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242001,3,1,1635076887000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242001,1,3,1635076917000,1)
</span></span><span style=display:flex><span>cat-second-agg&gt; GoodsCatTmp(202110242001,2,1,1635076911000,1)
</span></span></code></pre></div><ul><li>可以看到在 2021-10-24 20:00:00 到 2021-10-24 20:00:01 这个窗口内, 最终得到正确的结果: (1,1), (2,3), (3,1); 在 2021-10-24 20:00:01 到 2021-10-24 20:00:02 这个窗口内, 最终得到正确的结果: (1,3), (2,1), (3,1); 同时也正确的处理了乱序数据, 结果符合预期.</li></ul><h2 id=总结>总结
<a class=header-anchor href=#%e6%80%bb%e7%bb%93></a></h2><h3 id=关于-continuouseventtimetrigger-的使用>关于 ContinuousEventTimeTrigger 的使用
<a class=header-anchor href=#%e5%85%b3%e4%ba%8e-continuouseventtimetrigger-%e7%9a%84%e4%bd%bf%e7%94%a8></a></h3><ol><li>当每个事件时间的间隔大于定期触发的间隔时, 将会存在多次输出相同结果的情况<ul><li>次数: (下一个事件时间 - 上一个时间时间 - 1) / 定时器时间间隔, 结果取整</li></ul></li><li>窗口每个 key 的触发时间会出现不一致的情况, 当有新的数据进来时, 不论该 key 的数据是否存在更新, 会按定时触发的时间间隔输出该 key 的数据</li><li>当作为结果层触发输出时, 因结果层一般会采用幂等的方式保存结果数据, 即 upsert 方式, 不会存在重复统计的情况; 而作为中间结果层将会出现重复数据, 结果层需要对其做去重处理</li></ol><h2 id=参考>参考
<a class=header-anchor href=#%e5%8f%82%e8%80%83></a></h2><ul><li><a href=https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/stream/operators/windows.html#triggers title=triggers rel="noopener external nofollow noreferrer" target=_blank class=exturl>triggers
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/%e5%a4%a7%e6%95%b0%e6%8d%ae>大数据</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Flink Window Trigger 使用的正确姿势</li><li class=post-copyright-author><strong>本文作者： </strong>Patrick</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=/post/flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi/ title="Flink Window Trigger 使用的正确姿势">/post/flinkwindowtrigger-shi-yong-de-zheng-que-zi-shi/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/niu-ke---si-ze-yun-suan-jie-fa/ rel=next title=牛客-四则运算解法><i class="fa fa-chevron-left"></i> 牛客-四则运算解法</a></div><div class="post-nav-prev post-nav-item"><a href=/post/quickstart-of-flink/ rel=prev title="Flink QuickStart">Flink QuickStart
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2015 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Patrick</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.121.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://unpkg.com/animejs@3.2.1/lib/anime.min.js defer></script><script type=text/javascript src=https://unpkg.com/viewerjs@1.11.0/dist/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"unpkg","router":"https://unpkg.com"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script><script type=text/javascript src=/js/math.min.a6ada19a368d85dad9ead2040d86ae561a867fafef89391d1aa2aa5909366509.js defer></script></body></html>